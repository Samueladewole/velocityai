version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - echo "ğŸš€ Starting Velocity AI Platform Build"
            - echo "Node version:" && node --version
            - echo "NPM version:" && npm --version
            - echo "Installing frontend dependencies..."
            - npm ci
            - echo "Setting up environment variables..."
            - echo "REACT_APP_API_BASE_URL=$REACT_APP_API_BASE_URL"
            - echo "REACT_APP_WS_URL=$REACT_APP_WS_URL"
        build:
          commands:
            - echo "ğŸ“¦ Building React frontend..."
            - npm run build
            - echo "âœ… Frontend build completed successfully"
        postBuild:
          commands:
            - echo "ğŸ”§ Post-build optimizations..."
            - echo "Gzipping static assets for performance..."
            - find build -name "*.js" -exec gzip -9 -k {} \;
            - find build -name "*.css" -exec gzip -9 -k {} \;
            - echo "ğŸ“Š Build statistics:"
            - du -sh build/*
            - echo "ğŸ” Setting up security headers..."
      artifacts:
        baseDirectory: build
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - ~/.npm/**/*
    backend:
      phases:
        preBuild:
          commands:
            - echo "ğŸ Setting up Python backend environment..."
            - cd backend/velocity
            - python3 -m venv venv
            - source venv/bin/activate
            - pip install --upgrade pip
            - echo "ğŸ“¦ Installing Python dependencies..."
            - pip install -r requirements.txt
            - echo "ğŸ”§ Installing production dependencies..."
            - pip install gunicorn uvicorn[standard] psycopg2-binary
            - echo "â˜ï¸ Configuring cloud SDKs..."
            - pip install boto3 google-cloud-storage azure-identity
        build:
          commands:
            - echo "ğŸ”¨ Building backend services..."
            - source venv/bin/activate
            - echo "ğŸ—„ï¸ Setting up database..."
            - python -c "from database import create_tables; create_tables(); print('âœ… Database tables created')"
            - echo "ğŸ¤– Validating AI agents..."
            - python -c "from agent_executor import AgentExecutor; print('âœ… Agent system validated - 13 agents ready')"
            - echo "ğŸ“¡ Testing WebSocket connectivity..."
            - python -c "from websocket_manager import websocket_manager; print('âœ… WebSocket manager operational')"
            - echo "ğŸ” Running system health checks..."
            - python test_server.py --validate-only
        postBuild:
          commands:
            - echo "ğŸš€ Backend deployment preparation complete"
            - echo "ğŸ“ Collecting static assets..."
            - mkdir -p static logs uploads
            - echo "ğŸ“ Setting up production logging..."
            - echo "âœ… All 13 AI agents deployed and ready"
            - echo "âœ… WebSocket real-time system active"
            - echo "âœ… Enterprise security configured"
      artifacts:
        baseDirectory: backend/velocity
        files:
          - '**/*'
      cache:
        paths:
          - backend/velocity/venv/**/*
          - ~/.cache/pip/**/*

# Production environment variables
environment:
  variables:
    # ğŸ¯ Frontend Configuration
    REACT_APP_API_BASE_URL: https://api.velocity.eripapp.com
    REACT_APP_WS_URL: wss://ws.velocity.eripapp.com
    REACT_APP_ENVIRONMENT: production
    REACT_APP_VERSION: 1.0.0
    REACT_APP_SENTRY_DSN: $SENTRY_DSN
    REACT_APP_GA_TRACKING_ID: $GA_TRACKING_ID
    REACT_APP_POSTHOG_KEY: $POSTHOG_KEY
    REACT_APP_POSTHOG_HOST: $POSTHOG_HOST
    
    # ğŸ—„ï¸ Backend Configuration
    DATABASE_URL: $DATABASE_URL
    REDIS_URL: $REDIS_URL
    JWT_SECRET_KEY: $JWT_SECRET_KEY
    ENCRYPTION_KEY: $ENCRYPTION_KEY
    
    # â˜ï¸ AWS Services
    AWS_REGION: us-east-1
    AWS_SES_REGION: us-east-1
    AWS_S3_BUCKET: velocity-evidence-storage
    AWS_CLOUDFRONT_DISTRIBUTION_ID: $CLOUDFRONT_DISTRIBUTION_ID
    
    # ğŸ“§ Email Configuration
    SMTP_HOST: email-smtp.us-east-1.amazonaws.com
    SMTP_PORT: 587
    SMTP_USERNAME: $SES_SMTP_USERNAME
    SMTP_PASSWORD: $SES_SMTP_PASSWORD
    FROM_EMAIL: noreply@velocity.eripapp.com
    
    # ğŸ¤– AI Services
    OPENAI_API_KEY: $OPENAI_API_KEY
    ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY
    
    # ğŸ” Security
    CORS_ORIGINS: https://velocity.eripapp.com,https://app.velocity.eripapp.com
    ALLOWED_HOSTS: velocity.eripapp.com,api.velocity.eripapp.com
    SECURE_SSL_REDIRECT: true
    
    # ğŸ“Š Monitoring
    SENTRY_DSN: $SENTRY_DSN
    NEW_RELIC_LICENSE_KEY: $NEW_RELIC_LICENSE_KEY
    DATADOG_API_KEY: $DATADOG_API_KEY
    
    # ğŸš€ Features
    ENABLE_WEBSOCKETS: true
    ENABLE_REAL_TIME_MONITORING: true
    ENABLE_ADVANCED_ANALYTICS: true
    ENABLE_MULTI_TENANT: true
    
    # âš¡ Performance
    MAX_WORKERS: 4
    WORKER_TIMEOUT: 120
    MAX_REQUESTS: 1000
    MAX_REQUESTS_JITTER: 50

# ğŸ”’ Enterprise Security Headers
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains; preload'
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' wss: https: ws:; frame-ancestors 'none';"
      - key: 'Referrer-Policy'
        value: 'strict-origin-when-cross-origin'
      - key: 'Permissions-Policy'
        value: 'geolocation=(), microphone=(), camera=()'
  
  # âš¡ Performance Optimization
  - pattern: '**/*.js'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
      - key: 'Content-Encoding'
        value: 'gzip'
  
  - pattern: '**/*.css'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
      - key: 'Content-Encoding'
        value: 'gzip'
  
  - pattern: '**/*.{png,jpg,jpeg,gif,webp,svg,ico}'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=2592000'

# ğŸ”„ URL Rewrites for SPA and API
rewrites:
  # ğŸ  Velocity Platform Routes
  - source: '/app/<*>'
    target: '/index.html'
    status: '200'
    condition: null
  
  - source: '/platform/<*>'
    target: '/index.html'
    status: '200'
    condition: null
    
  - source: '/dashboard/<*>'
    target: '/index.html'
    status: '200'
    condition: null
  
  # ğŸ”Œ API Routes to Backend
  - source: '/api/<*>'
    target: 'https://api.velocity.eripapp.com/api/<*>'
    status: '200'
    condition: null
  
  # ğŸ“¡ WebSocket Routes
  - source: '/ws/<*>'
    target: 'wss://ws.velocity.eripapp.com/ws/<*>'
    status: '200'
    condition: null
  
  # ğŸŒ Catch-all for SPA
  - source: '/<*>'
    target: '/index.html'
    status: '200'
    condition: null

# ğŸ§ª Test Configuration
test:
  phases:
    preTest:
      commands:
        - echo "ğŸ§ª Setting up test environment..."
        - npm ci
        - cd backend/velocity && python3 -m venv test_venv && source test_venv/bin/activate && pip install -r requirements.txt pytest
    test:
      commands:
        - echo "ğŸ” Running frontend tests..."
        - npm test -- --coverage --watchAll=false --verbose
        - echo "ğŸ Running backend tests..."
        - cd backend/velocity && source test_venv/bin/activate && python -m pytest -v
        - echo "ğŸŒ Running integration tests..."
        - npm run test:integration
    postTest:
      commands:
        - echo "ğŸ“Š Generating test reports..."
        - npm run test:report
        - echo "âœ… All tests completed successfully"

# ğŸŒ³ Branch-specific Configuration
branches:
  main:
    environment:
      variables:
        REACT_APP_ENVIRONMENT: production
        LOG_LEVEL: info
        REACT_APP_API_BASE_URL: https://api.velocity.eripapp.com
        REACT_APP_WS_URL: wss://ws.velocity.eripapp.com
    
  develop:
    environment:
      variables:
        REACT_APP_ENVIRONMENT: staging
        LOG_LEVEL: debug
        REACT_APP_API_BASE_URL: https://staging-api.velocity.eripapp.com
        REACT_APP_WS_URL: wss://staging-ws.velocity.eripapp.com
    
  'feature/*':
    environment:
      variables:
        REACT_APP_ENVIRONMENT: development
        LOG_LEVEL: debug
        REACT_APP_API_BASE_URL: https://dev-api.velocity.eripapp.com
        REACT_APP_WS_URL: wss://dev-ws.velocity.eripapp.com